<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VK Photo Uploader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .step {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .step:last-child {
            border-bottom: none;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .step-number {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
            margin: 20px 0;
        }
        
        .upload-area:hover {
            background: #eef2ff;
            border-color: #5a67d8;
        }
        
        .upload-area.dragover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .analysis-results {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .analysis-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .analysis-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }
        
        .icon-success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .icon-warning {
            background: #feebc8;
            color: #744210;
        }
        
        .icon-error {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .progress-container {
            margin: 30px 0;
        }
        
        .progress-bar {
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #1a202c;
            padding: 15px;
            margin-top: 20px;
        }
        
        .log-entry {
            font-family: monospace;
            font-size: 0.9rem;
            padding: 8px;
            border-bottom: 1px solid #2d3748;
            color: #e2e8f0;
        }
        
        .log-success {
            color: #68d391;
        }
        
        .log-error {
            color: #fc8181;
        }
        
        .log-warning {
            color: #f6ad55;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-danger {
            background: #fc8181;
            color: white;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none !important;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì§ VK Photo Uploader</h1>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –≤ –∞–ª—å–±–æ–º –í–ö–æ–Ω—Ç–∞–∫—Ç–µ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏</p>
        </div>
        
        <!-- –®–ê–ì 1: –í–´–ë–û–† –ü–ê–ü–ö–ò -->
        <div class="card" id="step1">
            <div class="step-header">
                <div class="step-number">1</div>
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å —Ñ–∞–π–ª–∞–º–∏</h2>
            </div>
            
            <div class="upload-area" id="dropZone" onclick="document.getElementById('folderInput').click()">
                <div class="upload-icon">üìÅ</div>
                <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –ø–∞–ø–∫—É —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h3>
                <p style="color: #666; margin-top: 10px;">
                    –í –ø–∞–ø–∫–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å: config.txt, CSV —Ñ–∞–π–ª –∏ –≤—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                </p>
            </div>
            
            <input type="file" id="folderInput" webkitdirectory directory multiple hidden>
            
            <div id="fileList" class="file-list hidden"></div>
            <div id="analysisResults" class="analysis-results hidden"></div>
            
            <div class="buttons">
                <button id="checkBtn" class="btn-primary" onclick="checkFiles()" disabled>
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª—ã
                </button>
                <button id="testVKBtn" class="btn-secondary" onclick="testVKConnection()" disabled>
                    –¢–µ—Å—Ç VK
                </button>
            </div>
        </div>
        
        <!-- –®–ê–ì 2: –ó–ê–ì–†–£–ó–ö–ê -->
        <div class="card hidden" id="step2">
            <div class="step-header">
                <div class="step-number">2</div>
                <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –≤ VK</h2>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p style="text-align: center;" id="progressText">0%</p>
            </div>
            
            <div id="currentStatus" class="analysis-item">
                <div class="analysis-icon icon-info">‚è≥</div>
                <div>
                    <strong>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ...</strong>
                </div>
            </div>
            
            <div class="buttons">
                <button id="cancelBtn" class="btn-danger" onclick="cancelUpload()">
                    –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
                </button>
            </div>
        </div>
        
        <!-- –®–ê–ì 3: –†–ï–ó–£–õ–¨–¢–ê–¢–´ -->
        <div class="card hidden" id="step3">
            <div class="step-header">
                <div class="step-number">3</div>
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏</h2>
            </div>
            
            <div id="finalResults"></div>
            
            <div class="buttons">
                <button class="btn-primary" onclick="location.reload()">
                    –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É
                </button>
            </div>
        </div>
        
        <!-- –õ–û–ì –í–´–ü–û–õ–ù–ï–ù–ò–Ø -->
        <div class="card">
            <h3>üìã –õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
            <div class="log-container" id="logContainer">
                <div class="log-entry">
                    <span style="color: #63b3ed;">[–ì–æ—Ç–æ–≤]</span> –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å —Ñ–∞–π–ª–∞–º–∏.
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let selectedFiles = [];
        let currentSessionId = null;
        let uploadInProgress = false;
        let totalRows = 0;
        let currentRow = 0;
        
        // ==================== DOM –≠–õ–ï–ú–ï–ù–¢–´ ====================
        const dropZone = document.getElementById('dropZone');
        const folderInput = document.getElementById('folderInput');
        const fileList = document.getElementById('fileList');
        const analysisResults = document.getElementById('analysisResults');
        const checkBtn = document.getElementById('checkBtn');
        const testVKBtn = document.getElementById('testVKBtn');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const currentStatus = document.getElementById('currentStatus');
        const logContainer = document.getElementById('logContainer');
        const finalResults = document.getElementById('finalResults');
        
        // ==================== –§–£–ù–ö–¶–ò–ò –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ====================
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let color = '#e2e8f0';
            if (type === 'success') color = '#68d391';
            if (type === 'error') color = '#fc8181';
            if (type === 'warning') color = '#f6ad55';
            
            logEntry.innerHTML = `<span style="color: #a0aec0;">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // ==================== –û–ë–†–ê–ë–û–¢–ö–ê –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø ====================
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const items = e.dataTransfer.items;
            if (items) {
                for (let i = 0; i < items.length; i++) {
                    const entry = items[i].webkitGetAsEntry();
                    if (entry) {
                        traverseFileTree(entry);
                    }
                }
            }
        });
        
        function traverseFileTree(entry, path = '') {
            if (entry.isFile) {
                entry.file(file => {
                    file.filepath = path + file.name;
                    selectedFiles.push(file);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                    if (selectedFiles.length === 1) {
                        setTimeout(() => displayFiles(), 100);
                    }
                });
            } else if (entry.isDirectory) {
                const dirReader = entry.createReader();
                dirReader.readEntries(entries => {
                    for (let i = 0; i < entries.length; i++) {
                        traverseFileTree(entries[i], path + entry.name + '/');
                    }
                });
            }
        }
        
        folderInput.addEventListener('change', (e) => {
            selectedFiles = Array.from(e.target.files);
            displayFiles();
        });
        
        // ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –§–ê–ô–õ–û–í ====================
        function displayFiles() {
            if (!selectedFiles || selectedFiles.length === 0) {
                addLog('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤', 'warning');
                return;
            }
            
            fileList.classList.remove('hidden');
            fileList.innerHTML = '<h4>üìÅ –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</h4>';
            
            const configs = selectedFiles.filter(f => f.name.toLowerCase().includes('config') && f.name.toLowerCase().endsWith('.txt'));
            const csvs = selectedFiles.filter(f => f.name.toLowerCase().endsWith('.csv'));
            const photos = selectedFiles.filter(f => {
                const ext = f.name.toLowerCase().split('.').pop();
                return ['jpg', 'jpeg', 'png', 'gif'].includes(ext);
            });
            
            if (configs.length > 0) {
                const div = document.createElement('div');
                div.innerHTML = `<strong>‚úÖ config.txt:</strong> ${configs[0].name}`;
                fileList.appendChild(div);
            }
            
            if (csvs.length > 0) {
                const div = document.createElement('div');
                div.innerHTML = `<strong>‚úÖ CSV —Ñ–∞–π–ª:</strong> ${csvs[0].name}`;
                fileList.appendChild(div);
            }
            
            const div = document.createElement('div');
            div.innerHTML = `<strong>üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π:</strong> ${photos.length}`;
            fileList.appendChild(div);
            
            checkBtn.disabled = false;
            testVKBtn.disabled = false;
            
            addLog(`–í—ã–±—Ä–∞–Ω–æ ${selectedFiles.length} —Ñ–∞–π–ª–æ–≤`, 'success');
        }
        
        // ==================== –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í ====================
        async function checkFiles() {
            if (!selectedFiles || selectedFiles.length === 0) {
                addLog('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å —Ñ–∞–π–ª–∞–º–∏', 'error');
                return;
            }
            
            checkBtn.disabled = true;
            addLog('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤...', 'info');
            
            try {
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });
                
                const response = await fetch('/api/init', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentSessionId = data.session_id;
                    totalRows = data.total_rows || 0;
                    
                    addLog(`‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –ù–∞–π–¥–µ–Ω–æ ${totalRows} –∑–∞–ø–∏—Å–µ–π`, 'success');
                    
                    if (data.file_analysis) {
                        const analysis = data.file_analysis;
                        analysisResults.classList.remove('hidden');
                        
                        let html = '<h4>üìä –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤:</h4>';
                        
                        if (analysis.all_required_present) {
                            html += `<p style="color: #22543d;">‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã (${analysis.required_count})</p>`;
                        } else {
                            html += `<p style="color: #744210;">‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ${analysis.missing_count} —Ñ–∞–π–ª–æ–≤</p>`;
                            if (analysis.missing_files && analysis.missing_files.length > 0) {
                                html += '<p><strong>–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç:</strong> ' + analysis.missing_files.slice(0, 10).join(', ') + '</p>';
                            }
                        }
                        
                        if (analysis.extra_count > 0) {
                            html += `<p style="color: #744210;">üìÅ –õ–∏—à–Ω–∏–µ —Ñ–∞–π–ª—ã: ${analysis.extra_count}</p>`;
                        }
                        
                        analysisResults.innerHTML = html;
                        
                        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏
                        const startBtn = document.createElement('button');
                        startBtn.className = 'btn-primary';
                        startBtn.onclick = startUpload;
                        startBtn.innerHTML = 'üöÄ –ù–∞—á–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –≤ VK';
                        analysisResults.appendChild(startBtn);
                    }
                    
                } else {
                    addLog(`‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                    checkBtn.disabled = false;
                }
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
                console.error('Check files error:', error);
                checkBtn.disabled = false;
            }
        }
        
        // ==================== –¢–ï–°–¢ VK ====================
        async function testVKConnection() {
            if (!selectedFiles || selectedFiles.length === 0) {
                addLog('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å —Ñ–∞–π–ª–∞–º–∏', 'error');
                return;
            }
            
            testVKBtn.disabled = true;
            addLog('üîå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ VK...', 'info');
            
            try {
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });
                
                const response = await fetch('/api/test-vk', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VK —É—Å–ø–µ—à–Ω–æ!`, 'success');
                    if (data.user_info) {
                        addLog(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user_info.first_name || ''} ${data.user_info.last_name || ''}`, 'info');
                    }
                } else {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ VK: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                }
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            } finally {
                testVKBtn.disabled = false;
            }
        }
        
        // ==================== –ù–ê–ß–ê–õ–û –ó–ê–ì–†–£–ó–ö–ò ====================
        async function startUpload() {
            if (!currentSessionId) {
                addLog('‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏', 'error');
                return;
            }
            
            uploadInProgress = true;
            currentRow = 0;
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —à–∞–≥–∏
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            
            addLog('üöÄ –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ VK...', 'success');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –ø–æ –æ–¥–Ω–æ–π
            for (let i = 0; i < totalRows; i++) {
                if (!uploadInProgress) {
                    addLog('‚è∏Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞', 'warning');
                    break;
                }
                
                await processRow(i);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                const percent = ((i + 1) / totalRows * 100).toFixed(1);
                progressFill.style.width = percent + '%';
                progressText.textContent = percent + '%';
            }
            
            if (uploadInProgress) {
                await finalizeUpload();
            }
        }
        
        // ==================== –û–ë–†–ê–ë–û–¢–ö–ê –°–¢–†–û–ö–ò ====================
        async function processRow(rowIndex) {
            try {
                currentStatus.innerHTML = `
                    <div class="analysis-icon icon-info">‚è≥</div>
                    <div>
                        <strong>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ ${rowIndex + 1} –∏–∑ ${totalRows}</strong><br>
                        <small>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</small>
                    </div>
                `;
                
                addLog(`üìÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ ${rowIndex + 1}...`, 'info');
                
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });
                formData.append('session_id', currentSessionId);
                
                const response = await fetch(`/api/process-row/${rowIndex}`, {
                    method: 'POST',
                    headers: {
                        'X-Session-ID': currentSessionId
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.result || {};
                    if (result.success) {
                        addLog(`‚úÖ –°—Ç—Ä–æ–∫–∞ ${rowIndex + 1}: ${result.main_photo || ''} - –∑–∞–≥—Ä—É–∂–µ–Ω–æ`, 'success');
                    } else {
                        const error = result.errors ? result.errors[0] : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                        addLog(`‚ùå –°—Ç—Ä–æ–∫–∞ ${rowIndex + 1}: ${result.main_photo || ''} - ${error}`, 'error');
                    }
                } else {
                    addLog(`‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                }
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
                console.error('Process row error:', error);
            }
            
            // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        // ==================== –ó–ê–í–ï–†–®–ï–ù–ò–ï ====================
        async function finalizeUpload() {
            addLog('üìä –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...', 'info');
            
            try {
                const response = await fetch(`/api/finalize/${currentSessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    const report = data.report || {};
                    const stats = report.statistics || {};
                    
                    step2.classList.add('hidden');
                    step3.classList.remove('hidden');
                    
                    let html = '<h3>‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h3>';
                    html += `<p>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${stats.processed_rows || 0} –∏–∑ ${stats.total_rows || 0} —Å—Ç—Ä–æ–∫</p>`;
                    html += `<p>–£—Å–ø–µ—à–Ω–æ: ${stats.successful_rows || 0}</p>`;
                    html += `<p>–û—à–∏–±–æ–∫: ${stats.failed_rows || 0}</p>`;
                    
                    if (report.file_analysis) {
                        if (report.file_analysis.missing_count > 0) {
                            html += `<p style="color: #744210;">‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ —Ñ–∞–π–ª–æ–≤: ${report.file_analysis.missing_count}</p>`;
                        }
                        if (report.file_analysis.extra_count > 0) {
                            html += `<p style="color: #744210;">üìÅ –õ–∏—à–Ω–∏—Ö —Ñ–∞–π–ª–æ–≤: ${report.file_analysis.extra_count}</p>`;
                        }
                    }
                    
                    if (report.errors && report.errors.length > 0) {
                        html += '<h4>‚ùå –û—à–∏–±–∫–∏:</h4><ul style="color: #742a2a;">';
                        report.errors.slice(0, 5).forEach(err => {
                            html += `<li>${err}</li>`;
                        });
                        if (report.errors.length > 5) {
                            html += `<li>... –∏ –µ—â–µ ${report.errors.length - 5} –æ—à–∏–±–æ–∫</li>`;
                        }
                        html += '</ul>';
                    }
                    
                    finalResults.innerHTML = html;
                    
                    addLog('‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');
                    
                } else {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                }
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }
        
        // ==================== –û–¢–ú–ï–ù–ê ====================
        async function cancelUpload() {
            if (!currentSessionId) return;
            
            uploadInProgress = false;
            
            try {
                await fetch(`/api/cancel/${currentSessionId}`, {
                    method: 'POST'
                });
                addLog('‚è∏Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warning');
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —à–∞–≥—É 1
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ: ${error.message}`, 'error');
            }
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        addLog('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
    </script>
</body>
</html>
